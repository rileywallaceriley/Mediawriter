<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Media Writer</title>
  <link href="https://fonts.cdnfonts.com/css/press-start-2p" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .read-button {
      background-color: #222;
      color: #fff;
      border: none;
      padding: 8px 16px;
      margin-top: 10px;
      cursor: pointer;
      font-family: 'Press Start 2P', sans-serif;
      font-size: 10px;
    }
    .read-button:hover {
      background-color: #444;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://i.imgur.com/bIqJFyo.png" width="30%" />
  </header>

  <main class="story-feed">
    {% for story in stories %}
    <div class="story-card" id="card-{{ loop.index }}">
      <div class="story-title" id="title-{{ loop.index }}">{{ story.title }}</div>
      <div class="story-summary" id="summary-{{ loop.index }}">
        <em>Click rewrite to generate full summary.</em>
      </div>
      <button class="rewrite-button" onclick="rewriteStory('{{ story.link }}', '{{ story.title|e }}', {{ loop.index }})">REWRITE</button>
    </div>
    {% endfor %}
  </main>

  <script>
    async function rewriteStory(url, title, index) {
      const btn = document.querySelector(`#card-${index} .rewrite-button`);
      const summary = document.getElementById(`summary-${index}`);
      const titleEl = document.getElementById(`title-${index}`);

      btn.disabled = true;
      btn.textContent = "Rewriting...";

      try {
        const res = await fetch('/rewrite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, title })
        });

        const data = await res.json();

        if (data.error) {
          summary.innerHTML = `<span style="color:red;">${data.error}</span>`;
        } else {
          // Replace the title and summary with rewritten content
          titleEl.innerText = data.new_title;
          summary.innerHTML = `<p>${data.new_body.replace(/\n/g, '</p><p>')}</p>`;

          // --- ADD: WordPress publish form dynamically ---
          const publishForm = document.createElement('form');
          publishForm.method = 'POST';
          publishForm.action = '/publish';
          publishForm.innerHTML = `
            <input type="hidden" name="title" value="${data.new_title}">
            <input type="hidden" name="content" value="${data.new_body}">
            <button type="submit" class="read-button">PUBLISH TO WORDPRESS</button>
          `;
          summary.appendChild(publishForm);
        }
      } catch (err) {
        summary.innerHTML = `<span style="color:red;">Request failed.</span>`;
      }

      btn.disabled = false;
      btn.textContent = "REWRITE AGAIN";
    }
  </script>
</body>
</html>